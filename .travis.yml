language: csharp
solution: Sibusten.Philomena.Api.sln
mono: none
dotnet: 5.0.101
os: linux
dist: xenial

env:
  - CONFIGURATION=Debug
  - CONFIGURATION=Release

jobs:
  include:
    - stage: "Build"
      script: dotnet build -c $CONFIGURATION

    - stage: "Test"
      script: dotnet test --no-build -c $CONFIGURATION

    - stage: "Deploy"
      if: branch = main AND tag IS present
      env: CONFIGURATION=Release  # Only deploy with release configuration
      script: dotnet pack ./Sibusten.Philomena.Api/Sibusten.Philomena.Api.csproj -c $CONFIGURATION
      deploy:
        provider: script
        edge: true
        script: dotnet nuget push ./Sibusten.Philomena.Api/bin/$CONFIGURATION/Sibusten.Philomena.Api.*.nupkg -k $NUGET_API_KEY -s https://api.nuget.org/v3/index.json
